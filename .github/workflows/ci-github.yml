name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - bug
      - fix
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: "https://salutcava.github.io/playwright_sample_site/"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Display URL
        run: echo "Site deployed at https://salutcava.github.io/playwright_sample_site/"

  trigger-e2e-tests:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Trigger E2E Tests
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.E2E_PAT }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'salutcava',
              repo: 'playwright_sample_e2e',
              workflow_id: 'e2e-tests.yml',
              ref: 'main',
              inputs: {
                site_url: 'https://salutcava.github.io/playwright_sample_site/',
                source_branch: '${{ github.ref_name }}',
                source_sha: '${{ github.sha }}',
                source_repo: '${{ github.repository }}'
              }
            })